<head>
    <meta charset="utf8">
    <title>minimal</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <script type="text/javascript" src="cookies.js"></script>
    <script type="text/javascript">
        var xhr, requests, callback, loading;

        callback = requests = [];
        loading = true;

        function getHandler() {
            try{
                return new XMLHttpRequest();
            }catch(e){}

            try{
                return new ActiveXObject("Msxml2.XMLHTTP.6.0");
            }catch(e){}

            try{
                return new ActiveXObject("Msxml2.XMLHTTP.3.0");
            }catch(e){}

            try{
                return new ActiveXObject("Microsoft.XMLHttp");
            }catch(e){}

            console.err("Could not find XMLHttpRequest");
        }

        xhr = new getHandler();

        function pair(object, w) {
            var array, i;
            array = Object.keys(object);
            for (i = 0; i < array.length; i++)
                array[i] += w + object[array[i]];
            return array;
        }
        function transit(x) {
            return x.split("=").map(function(y){ return encodeURIComponent(y); }).join("=");
        }
        function prepare(object) {
            var a = pair(flatten(object), "=").map(transit).join("&");
            this.query = a;
            return a;
        }

        function Request(url) {
            var method = "GET";
            function getMethod() {
                return method;
            }
            function setMethod(v) {
                v = v.toUpperCase();
                if (v != "GET" && v != "POST")
                    return false;

                method = v;
            }
            function action(cb) {
                this.callback = cb.bind(this);
            }
            function start() {
                if (this.used === false)
                    requests.push(this);

                if(loading)
                    return false;

                loading = this.used = true;

                if (method == "GET")
                {
                    xhr.open(method, url +"?" + this.query);
                    xhr.send(null);
                }
                else if (method == "POST")
                {
                    xhr.open(method, url);
                    xhr.send(this.query);
                }
            }
            this.setMethod = setMethod.bind(this);
            this.getMethod = getMethod.bind(this);
            this.action = action.bind(this);
            this.start = start.bind(this);
            this.prepare = prepare.bind(this);
            this.used = false;
            this.callback = (function(){}).bind(this);

            return this;
        }

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                requests.shift().callback();

                loading = false;

                if (requests.length > 0 && requests[0].used === false)
                    requests[0].start();
            }
        };
    </script>
</head>
<body>
    <h1>Minimal</h1>
    <form name=user method=POST action="query">
        <label for="name">username</label>
        <input name=name>

        <label for=password>password</label>
        <input name=password type=password>

        <button name=action>verify</button>
    </form>
    <form name=chat method=POST action="query">
        <label for=message>message</label>
        <input name=message>

        <button name=action>send</button>
    </form>
    <p id="output">loading...</p>
    <script type="text/javascript">
        loading = false;
        var out, button, $, request, cookies, ident, last;

        $ = document.querySelector.bind(document);

        out = $("#output");
        button = $("button");

        cookies = new Bakery();

        cookies.devour(document.cookie);

        ident = cookies.find("identity");

        document.forms.user.addEventListener("submit", function(e) {
            e.preventDefault();

            request = new Request("/query");

            request.prepare({
                id: ident,
                name: document.forms.user.name.value,
                pass: document.forms.user.password.value,
                action: "verify"
            });

            request.action(function() {
                out.innerHTML = xhr.responseText;
            });

            request.start();

            return false;
        });
        document.forms.chat.addEventListener("submit", function(e) {
            e.preventDefault();

            var message;

            request = new Request("/query");
            message = document.forms.chat.message.value.trim();

            if (message <= 1 || message.length > 140)
                return false;

            request.prepare({
                id: ident,
                name: document.forms.user.name.value,
                message: document.forms.chat.message.value,
                action: "send"
            });

            request.action(function() {
                document.forms.chat.message.value = "";
                out.innerHTML = xhr.responseText;
            });

            request.start();

            return false;
        });
        var chat = new Chat();
        function update() {
            request = new Request("/query");
            request.prepare({
                id: ident,
                update: chat.position
            });
            request.action(function() {
                chat.read(xhr.responseText);
            });
            request.start();
            setTimeout(update, 1000);
        }
        function Chat() {
            this.position = 0;

            function read(logs) {
                logs = JSON.parse(logs);
                this.position += logs.length;
                if (logs.length > 0)
                    print(logs);
            }
            function print(logs) {
                for (var key in logs)
                    if (logs.hasOwnProperty(key))
                        show(logs[key]);
            }
            function show(packet) {
                console.log(packet.name, packet.message);
            }
            this.read = read.bind(this);

            return this;
        }
        setTimeout(update, 1000);
    </script>
</body>
